<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Relat√≥rios - Gestor de Incidentes</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="../static/css/style.css">
    <link rel="stylesheet" href="../static/css/dashboard.css">
</head>
<body class="dashboard">
    <!-- Navbar -->
    <nav class="dashboard-navbar">
        <div class="navbar-content">
            <h2 class="navbar-brand">üö® Gestor de Incidentes</h2>
            <div class="navbar-menu">
                <a href="dashboard-gestor.html">Dashboard</a>
                <a href="incident_list.html">Incidentes</a>
                <a href="reports.html" class="active">Relat√≥rios</a>
            </div>
        </div>
    </nav>

    <div class="dashboard-container">
        <!-- Header -->
        <div class="dashboard-header">
            <div>
                <h1>Relat√≥rios e An√°lises</h1>
                <p style="color: #7f8c8d; margin: 0;">An√°lise detalhada de incidentes e m√©tricas de desempenho</p>
            </div>
            <div class="user-info">
                <div class="avatar" id="userAvatar">U</div>
                <div class="user-details">
                    <p class="user-name" id="userName">Utilizador</p>
                    <p class="user-role" id="userRole">Perfil</p>
                </div>
                <button class="logout-btn" onclick="logout()">Sair</button>
            </div>
        </div>

        <!-- Filtros de Relat√≥rio -->
        <div class="filter-section">
            <h3 class="filter-title">üìä Par√¢metros do Relat√≥rio</h3>
            <div class="filter-group">
                <div class="filter-item">
                    <label for="reportPeriod">Per√≠odo:</label>
                    <select id="reportPeriod">
                        <option value="week">√öltima Semana</option>
                        <option value="month" selected>√öltimo M√™s</option>
                        <option value="quarter">√öltimo Trimestre</option>
                        <option value="year">√öltimo Ano</option>
                    </select>
                </div>
                <div class="filter-item">
                    <label for="reportCategory">Categoria:</label>
                    <select id="reportCategory">
                        <option value="">Todas</option>
                        <!-- Preenchido dinamicamente por options.js -->
                    </select>
                </div>
                <div class="filter-item">
                    <button class="btn-apply" onclick="generateReport()">Gerar Relat√≥rio</button>
                </div>
            </div>
        </div>

        <!-- M√©tricas do Relat√≥rio -->
        <div class="metrics-grid">
            <div class="metric-card mttr">
                <p class="metric-label">‚è±Ô∏è MTTR (Tempo M√©dio de Resolu√ß√£o)</p>
                <p class="metric-value" id="reportMttr">0.0</p>
                <p class="metric-unit">horas</p>
            </div>

            <div class="metric-card total">
                <p class="metric-label">üìä Total de Incidentes</p>
                <p class="metric-value" id="reportTotal">0</p>
                <p class="metric-unit">no per√≠odo</p>
            </div>

            <div class="metric-card critical">
                <p class="metric-label">üî¥ Incidentes Cr√≠ticos</p>
                <p class="metric-value" id="reportCritical">0</p>
                <p class="metric-unit">registados</p>
            </div>

            <div class="metric-card resolved">
                <p class="metric-label">‚úÖ Taxa de Resolu√ß√£o</p>
                <p class="metric-value" id="reportResolvedRate">0%</p>
                <p class="metric-unit">resolvidos</p>
            </div>
        </div>

        <!-- Gr√°ficos -->
        <div class="charts-grid">
            <div class="chart-container">
                <h3 class="chart-title">üìà Incidentes por Prioridade</h3>
                <div class="placeholder-chart">
                    Gr√°fico: Distribui√ß√£o por Prioridade
                    <br>(Chart.js / Canvas - a implementar)
                </div>
            </div>

            <div class="chart-container">
                <h3 class="chart-title">üè∑Ô∏è Incidentes por Categoria</h3>
                <div class="placeholder-chart">
                    Gr√°fico: Distribui√ß√£o por Categoria
                    <br>(Chart.js / Canvas - a implementar)
                </div>
            </div>

            <div class="chart-container">
                <h3 class="chart-title">üìä Evolu√ß√£o Temporal</h3>
                <div class="placeholder-chart">
                    Gr√°fico: Incidentes ao Longo do Tempo
                    <br>(Chart.js / Canvas - a implementar)
                </div>
            </div>

            <div class="chart-container">
                <h3 class="chart-title">‚è≥ Tempo de Resolu√ß√£o</h3>
                <div class="placeholder-chart">
                    Gr√°fico: Distribui√ß√£o de Tempos de Resolu√ß√£o
                    <br>(Chart.js / Canvas - a implementar)
                </div>
            </div>
        </div>

        <!-- Tabela de Resumo -->
        <div class="table-container">
            <h3 class="table-title">üìã Resumo por Categoria</h3>
            <div class="table-responsive">
                <table>
                    <thead>
                        <tr>
                            <th>Categoria</th>
                            <th>Total</th>
                            <th>Abertos</th>
                            <th>Resolvidos</th>
                            <th>MTTR (horas)</th>
                        </tr>
                    </thead>
                    <tbody id="reportTableBody">
                        <!-- Preenchido por JavaScript -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="../static/js/main.js"></script>
    <script src="../static/js/api.js"></script>
    <script src="../static/js/options.js"></script>
    <script src="../static/js/dashboard.js"></script>
    <script>
        // Carregar op√ß√µes dinamicamente e atualizar info do utilizador
        document.addEventListener('DOMContentLoaded', async () => {
            updateUserInfo();
            await loadOptions();
        });
    </script>
    <script>
        // Garantir que s√≥ gestores acedem
        document.addEventListener('DOMContentLoaded', () => {
            const user = requireAuth();
            if (!user || user.role !== 'gestor') {
                window.location.href = '../index.html';
                return;
            }

            updateUserInfo();
            generateReport();
        });

        async function generateReport() {
            try {
                // Carregar incidentes
                const data = await loadIncidents();
                const allIncidents = Array.isArray(data.incidents) ? data.incidents : [];

                // Aplicar filtros de per√≠odo
                const period = document.getElementById('reportPeriod').value;
                const category = document.getElementById('reportCategory').value;
                
                let filteredIncidents = [...allIncidents];

                // Filtrar por per√≠odo
                const now = new Date();
                const startDate = new Date(now);
                switch (period) {
                    case 'week':
                        startDate.setDate(now.getDate() - 7);
                        break;
                    case 'month':
                        startDate.setMonth(now.getMonth() - 1);
                        break;
                    case 'quarter':
                        startDate.setMonth(now.getMonth() - 3);
                        break;
                    case 'year':
                        startDate.setFullYear(now.getFullYear() - 1);
                        break;
                }

                filteredIncidents = filteredIncidents.filter(inc => {
                    const createdAt = inc.createdAt || inc.created_at;
                    if (!createdAt) return false;
                    const created = new Date(createdAt);
                    return !isNaN(created) && created >= startDate;
                });

                // Filtrar por categoria
                if (category) {
                    filteredIncidents = filteredIncidents.filter(inc => inc.category === category);
                }

                // Calcular m√©tricas
                const total = filteredIncidents.length;
                const critical = filteredIncidents.filter(inc => inc.priority === 'Cr√≠tica').length;
                const resolved = filteredIncidents.filter(inc => inc.status === 'Resolvido').length;
                const resolvedRate = total > 0 ? ((resolved / total) * 100).toFixed(1) : 0;

                // Calcular MTTR
                const resolvedIncidents = filteredIncidents.filter(inc => {
                    const statusResolved = inc.status === 'Resolvido' || inc.status === 'Fechado';
                    const hasDates = (inc.resolvedAt || inc.resolved_at) && (inc.createdAt || inc.created_at);
                    return statusResolved && hasDates;
                });

                let mttr = 0;
                if (resolvedIncidents.length > 0) {
                    const totalHours = resolvedIncidents.reduce((sum, inc) => {
                        const created = new Date(inc.createdAt || inc.created_at);
                        const resolvedDate = new Date(inc.resolvedAt || inc.resolved_at);
                        if (isNaN(created) || isNaN(resolvedDate)) return sum;
                        const hours = (resolvedDate - created) / (1000 * 60 * 60);
                        return sum + (hours > 0 ? hours : 0);
                    }, 0);
                    mttr = totalHours / resolvedIncidents.length;
                }

                // Atualizar m√©tricas
                document.getElementById('reportMttr').textContent = mttr > 0 ? mttr.toFixed(1) : '0.0';
                document.getElementById('reportTotal').textContent = total;
                document.getElementById('reportCritical').textContent = critical;
                document.getElementById('reportResolvedRate').textContent = resolvedRate + '%';

                // Gerar tabela por categoria
                const categories = {};
                filteredIncidents.forEach(inc => {
                    const cat = inc.category || 'Outros';
                    if (!categories[cat]) {
                        categories[cat] = { total: 0, open: 0, resolved: 0, resolvedDates: [] };
                    }
                    categories[cat].total++;
                    if (inc.status === 'Aberto' || inc.status === 'Em Progresso') {
                        categories[cat].open++;
                    }
                    if (inc.status === 'Resolvido') {
                        categories[cat].resolved++;
                        if (inc.resolvedAt || inc.resolved_at) {
                            categories[cat].resolvedDates.push({
                                created: inc.createdAt || inc.created_at,
                                resolved: inc.resolvedAt || inc.resolved_at
                            });
                        }
                    }
                });

                const tbody = document.getElementById('reportTableBody');
                tbody.innerHTML = '';
                
                Object.keys(categories).forEach(cat => {
                    const catData = categories[cat];
                    let catMttr = 0;
                    if (catData.resolvedDates.length > 0) {
                        const totalHours = catData.resolvedDates.reduce((sum, d) => {
                            const created = new Date(d.created);
                            const resolved = new Date(d.resolved);
                            if (isNaN(created) || isNaN(resolved)) return sum;
                            const hours = (resolved - created) / (1000 * 60 * 60);
                            return sum + (hours > 0 ? hours : 0);
                        }, 0);
                        catMttr = totalHours / catData.resolvedDates.length;
                    }

                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td><strong>${cat}</strong></td>
                        <td>${catData.total}</td>
                        <td>${catData.open}</td>
                        <td>${catData.resolved}</td>
                        <td>${catMttr > 0 ? catMttr.toFixed(1) : '-'}</td>
                    `;
                    tbody.appendChild(row);
                });

            } catch (err) {
                console.error("Erro ao gerar relat√≥rio:", err);
                showNotification("Erro ao gerar relat√≥rio.", "error");
            }
        }
    </script>
</body>
</html>

